From 7421f0951f48b859930b4fa54cc8ba189fdf5c45 Mon Sep 17 00:00:00 2001
From: qjohn <townex22@gmail.com>
Date: Tue, 22 May 2018 19:16:36 +0000
Subject: [PATCH] Settings: Implement Dynamic System Bars [2/2]

 * Bring in to Oreo :p

Change-Id: I7d0f008e71b47d3db607f1a1588939c5e43ea90b
Signed-off-by: qjohn <townex22@gmail.com>
---
 res/values-in/shit_strings.xml   |  31 ++++++++
 res/values/shit_strings.xml      |  31 ++++++++
 res/xml/display_settings.xml     |   6 ++
 res/xml/dsb_settings.xml         |  40 ++++++++++
 src/in/parashit/DSBSettings.java | 166 +++++++++++++++++++++++++++++++++++++++
 5 files changed, 274 insertions(+)
 create mode 100644 res/values-in/shit_strings.xml
 create mode 100644 res/values/shit_strings.xml
 create mode 100644 res/xml/dsb_settings.xml
 create mode 100644 src/in/parashit/DSBSettings.java

diff --git a/res/values-in/shit_strings.xml b/res/values-in/shit_strings.xml
new file mode 100644
index 0000000..ab8a05b
--- /dev/null
+++ b/res/values-in/shit_strings.xml
@@ -0,0 +1,31 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2018 ParaSHIT Project
+
+     This program is free software: you can redistribute it and/or modify
+     it under the terms of the GNU General Public License as published by
+     the Free Software Foundation, either version 3 of the License, or
+     (at your option) any later version
+
+     This program is distributed in the hope that it will be useful,
+     but WITHOUT ANY WARRANTY; without even the implied warranty of
+     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+     GNU General Public License for more details.
+
+     You should have received a copy of the GNU General Public License
+     along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ -->
+
+<resources xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <!-- Dynamic system bars -->
+    <string name="dynamic_system_bars_title">Bilah sistem dinamis</string>
+    <string name="dynamic_system_bars_summary">Mengadaptasikan warna bilah sistem sesuai dengan warna utama aplikasi yang sedang berjalan</string>
+    <string name="dynamic_status_bar_title">Bilah status dinamis</string>
+    <string name="dynamic_status_bar_summary">Secara otomatis memperbarui latar belakang bilah status</string>
+    <string name="dynamic_navigation_bar_title">Bilah navigasi dinamis</string>
+    <string name="dynamic_navigation_bar_summary">Secara otomatis memperbarui latar belakang bilah navigasi</string>
+    <string name="dynamic_system_bars_gradient_title">Gradasi bilah sistem</string>
+    <string name="dynamic_system_bars_gradient_summary">Melapiskan gradasi pada bilah sistem</string>
+    <string name="dynamic_status_bar_filter_title">Bilah status gelap</string>
+    <string name="dynamic_status_bar_filter_summary">Melapiskan filter gelap pada bilah status</string>
+</resources>
diff --git a/res/values/shit_strings.xml b/res/values/shit_strings.xml
new file mode 100644
index 0000000..715d9e8
--- /dev/null
+++ b/res/values/shit_strings.xml
@@ -0,0 +1,31 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2018 ParaSHIT Project
+
+     This program is free software: you can redistribute it and/or modify
+     it under the terms of the GNU General Public License as published by
+     the Free Software Foundation, either version 3 of the License, or
+     (at your option) any later version
+
+     This program is distributed in the hope that it will be useful,
+     but WITHOUT ANY WARRANTY; without even the implied warranty of
+     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+     GNU General Public License for more details.
+
+     You should have received a copy of the GNU General Public License
+     along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ -->
+
+<resources xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <!-- Dynamic system bars -->
+    <string name="dynamic_system_bars_title">Dynamic system bars</string>
+    <string name="dynamic_system_bars_summary">Adapt system bars color to match foreground running app primary color</string>
+    <string name="dynamic_status_bar_title">Dynamic status bar</string>
+    <string name="dynamic_status_bar_summary">Automatically update the background of the status bar</string>
+    <string name="dynamic_navigation_bar_title">Dynamic navigation bar</string>
+    <string name="dynamic_navigation_bar_summary">Automatically update the background of the navigation bar</string>
+    <string name="dynamic_system_bars_gradient_title">System bar gradient</string>
+    <string name="dynamic_system_bars_gradient_summary">Overlay a gradient on the system bars</string>
+    <string name="dynamic_status_bar_filter_title">Darker status bar</string>
+    <string name="dynamic_status_bar_filter_summary">Overlay a darkening filter on the status bar</string>
+</resources>
diff --git a/res/xml/display_settings.xml b/res/xml/display_settings.xml
index 065197b..1f8a684 100644
--- a/res/xml/display_settings.xml
+++ b/res/xml/display_settings.xml
@@ -173,4 +173,10 @@
         android:title="@string/display_vr_pref_title"
         android:fragment="com.android.settings.display.VrDisplayPreferencePicker" />
 
+    <PreferenceScreen
+        android:key="dynamic_system_bars"
+        android:title="@string/dynamic_system_bars_title"
+        android:summary="@string/dynamic_system_bars_summary"
+        android:fragment="in.parashit.DSBSettings" />
+
 </PreferenceScreen>
diff --git a/res/xml/dsb_settings.xml b/res/xml/dsb_settings.xml
new file mode 100644
index 0000000..901ebce
--- /dev/null
+++ b/res/xml/dsb_settings.xml
@@ -0,0 +1,40 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2013 ParanoidAndroid Project
+               (C) 2016-2018 ParaSHIT
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android"
+        android:title="@string/dynamic_system_bars_title">
+
+    <SwitchPreference
+        android:key="dynamic_status_bar"
+        android:title="@string/dynamic_status_bar_title"
+        android:summary="@string/dynamic_status_bar_summary" />
+
+    <SwitchPreference
+        android:key="dynamic_navigation_bar"
+        android:title="@string/dynamic_navigation_bar_title"
+        android:summary="@string/dynamic_navigation_bar_summary" />
+
+    <SwitchPreference
+        android:key="dynamic_system_bars_gradient"
+        android:title="@string/dynamic_system_bars_gradient_title"
+        android:summary="@string/dynamic_system_bars_gradient_summary" />
+
+    <SwitchPreference
+        android:key="dynamic_status_bar_filter"
+        android:title="@string/dynamic_status_bar_filter_title"
+        android:summary="@string/dynamic_status_bar_filter_summary" />
+</PreferenceScreen>
diff --git a/src/in/parashit/DSBSettings.java b/src/in/parashit/DSBSettings.java
new file mode 100644
index 0000000..16dc5da
--- /dev/null
+++ b/src/in/parashit/DSBSettings.java
@@ -0,0 +1,166 @@
+/*
+ * Copyright (C) 2013 ParanoidAndroid Project
+ *           (C) 2016-2018 ParaSHIT
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package in.parashit;
+
+import android.content.ContentResolver;
+import android.content.res.Resources;
+import android.os.Bundle;
+import android.os.RemoteException;
+import android.provider.Settings;
+import android.support.v7.preference.Preference;
+import android.support.v14.preference.SwitchPreference;
+import android.view.IWindowManager;
+import android.view.WindowManagerGlobal;
+
+import com.android.internal.logging.nano.MetricsProto.MetricsEvent;
+import com.android.settings.R;
+import com.android.settings.SettingsPreferenceFragment;
+
+public class DSBSettings extends SettingsPreferenceFragment {
+
+    private static final String KEY_DYNAMIC_STATUS_BAR =
+            "dynamic_status_bar";
+    private static final String KEY_DYNAMIC_NAVIGATION_BAR =
+            "dynamic_navigation_bar";
+    private static final String KEY_DYNAMIC_SYSTEM_BARS_GRADIENT =
+            "dynamic_system_bars_gradient";
+    private static final String KEY_DYNAMIC_STATUS_BAR_FILTER =
+            "dynamic_status_bar_filter";
+
+    private SwitchPreference mDynamicStatusBar;
+    private SwitchPreference mDynamicNavigationBar;
+    private SwitchPreference mDynamicSystemBarsGradient;
+    private SwitchPreference mDynamicStatusBarFilter;
+
+    @Override
+    public void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+
+        addPreferencesFromResource(R.xml.dsb_settings);
+
+        mDynamicStatusBar =
+                (SwitchPreference) findPreference(KEY_DYNAMIC_STATUS_BAR);
+        mDynamicStatusBar.setPersistent(false);
+
+        mDynamicNavigationBar =
+                (SwitchPreference) findPreference(KEY_DYNAMIC_NAVIGATION_BAR);
+        mDynamicNavigationBar.setPersistent(false);
+
+        mDynamicSystemBarsGradient =
+                (SwitchPreference) findPreference(KEY_DYNAMIC_SYSTEM_BARS_GRADIENT);
+        mDynamicSystemBarsGradient.setPersistent(false);
+
+        mDynamicStatusBarFilter =
+                (SwitchPreference) findPreference(KEY_DYNAMIC_STATUS_BAR_FILTER);
+        mDynamicStatusBarFilter.setPersistent(false);
+
+        updateDynamicSystemBarsSwitches();
+    }
+
+    private void updateDynamicSystemBarsSwitches() {
+        ContentResolver resolver = getActivity().getContentResolver();
+
+        final boolean isStatusBarDynamic = Settings.System.getInt(resolver,
+                Settings.System.DYNAMIC_STATUS_BAR_STATE, 0) == 1;
+
+        boolean hasNavigationBar;
+        try {
+            IWindowManager wm = WindowManagerGlobal.getWindowManagerService();
+            hasNavigationBar = wm.hasNavigationBar();
+        } catch (RemoteException e) {
+            hasNavigationBar = false;
+        }
+
+        final boolean isNavigationBarDynamic = hasNavigationBar &&
+                Settings.System.getInt(resolver,
+                        Settings.System.DYNAMIC_NAVIGATION_BAR_STATE,
+                                0) == 1;
+
+        final boolean isAnyBarDynamic = isStatusBarDynamic
+                || isNavigationBarDynamic;
+
+        mDynamicStatusBar.setChecked(isStatusBarDynamic);
+
+        mDynamicNavigationBar.setEnabled(hasNavigationBar);
+        mDynamicNavigationBar.setChecked(isNavigationBarDynamic);
+
+        final boolean areSystemBarsGradient = isAnyBarDynamic &&
+                Settings.System.getInt(resolver,
+                        Settings.System.DYNAMIC_SYSTEM_BARS_GRADIENT_STATE,
+                                0) == 1;
+        final boolean isStatusBarFilter = isStatusBarDynamic &&
+                Settings.System.getInt(resolver,
+                        Settings.System.DYNAMIC_STATUS_BAR_FILTER_STATE,
+                                0) == 1;
+
+        mDynamicSystemBarsGradient.setEnabled(isAnyBarDynamic &&
+                (areSystemBarsGradient || !isStatusBarFilter));
+        mDynamicSystemBarsGradient.setChecked(areSystemBarsGradient);
+
+        mDynamicStatusBarFilter.setEnabled(isStatusBarDynamic &&
+                (isStatusBarFilter || !areSystemBarsGradient));
+        mDynamicStatusBarFilter.setChecked(isStatusBarFilter);
+    }
+
+    @Override
+    public boolean onPreferenceTreeClick(Preference preference) {
+        ContentResolver resolver = getActivity().getContentResolver();
+        if (preference == mDynamicStatusBar) {
+            Settings.System.putInt(resolver,
+                    Settings.System.DYNAMIC_STATUS_BAR_STATE,
+                    mDynamicStatusBar.isChecked() ? 1 : 0);
+            updateDynamicSystemBarsSwitches();
+        } else if (preference == mDynamicNavigationBar) {
+            final Resources res = getResources();
+            Settings.System.putInt(resolver,
+                    Settings.System.DYNAMIC_NAVIGATION_BAR_STATE,
+                    mDynamicNavigationBar.isChecked()
+                    && res.getDimensionPixelSize(
+                            res.getIdentifier("navigation_bar_height",
+                            "dimen", "android")) > 0 ? 1 : 0);
+            updateDynamicSystemBarsSwitches();
+        } else if (preference == mDynamicSystemBarsGradient) {
+            final boolean enableGradient =
+                    mDynamicSystemBarsGradient.isChecked();
+            Settings.System.putInt(resolver,
+                    Settings.System.DYNAMIC_SYSTEM_BARS_GRADIENT_STATE,
+                    enableGradient ? 1 : 0);
+            if (enableGradient) {
+                Settings.System.putInt(resolver,
+                        Settings.System.DYNAMIC_STATUS_BAR_FILTER_STATE, 0);
+            }
+            updateDynamicSystemBarsSwitches();
+        } else if (preference == mDynamicStatusBarFilter) {
+            final boolean enableFilter = mDynamicStatusBarFilter.isChecked();
+            Settings.System.putInt(resolver,
+                    Settings.System.DYNAMIC_STATUS_BAR_FILTER_STATE,
+                    enableFilter ? 1 : 0);
+            if (enableFilter) {
+                Settings.System.putInt(resolver,
+                        Settings.System.DYNAMIC_SYSTEM_BARS_GRADIENT_STATE, 0);
+            }
+            updateDynamicSystemBarsSwitches();
+        }
+        return super.onPreferenceTreeClick(preference);
+    }
+
+    @Override
+    public int getMetricsCategory() {
+        return MetricsEvent.PARASHIT;
+    }
+}
-- 
2.7.4

